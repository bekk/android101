---
layout: default
title: Manuscript
---
<h3>Introduction</h3>
In this session we will create an app where the user can search for a Spotify track, and play the found track on a device. Remember to have
an updated version of Android Studio

<h3>Main</h3>
<ol>
	<li>Open Android Studio, create an empty project.</li>
    <li>Run Hello World app and explain debugging.</li>
	<li>Explain Activities (<a href="android-app-structure-and-components.html"> App Structure And Components</a>)</li>
    <li>Explain the Android Manifest</li>
	<li>Explain layouts and layout controls (<a href="common-view-controls.html"> Common View Controls</a>), (<a href="view-layout.html"> View Layout</a>))</li>
	<li>Explain the UI builder</li>
	<li>Create the MainActivity for the Spotify app. MainActivity will display an input text field and a button. </li>
    <li>Create the layout files and controls for the activity.</li>
    <li>Create a click listener for the button. This is where we want to initiate the search. Explain AsyncTasks (<a href="working-in-the-background.html"> Working In the Background.</a>)
    	Say that for this course we will use Retrofit, and provide Retrofit basics (background thread, GSON, etc). Add Gradle dependency:
        <p><code> compile 'com.squareup.retrofit:retrofit:1.9.0'</code></p></li>
	<li>Add SpotifySearchService which is the Retrofit interface. Maybe live code this. Also, add URL as a final variable to the MainActivity.
        <p><code>"/search/1/track.json"</code></p>
        <p><code>http://ws.spotify.com/</code></p>
    </li>
    <li> Create the Result object and explain its connection to the JSON structure returned by the Spotify API. It will hold a list of tracks.</li>
    <li> Create the Artist and Track domain objects. Copy these</li>
    <li> Create an instance of RestAdapter, and use this to instansiate the SpotifySearchService. Add the rest call to the created click listener. </li>
    <li> Run the app and perform a search. Add a Toast to the success callback</li>

    <p><code> PAUSE / SWITCH PRESENTER</code></p></li>

	<li>Do not add internet permission until app has run and failed. Explain the need for permissions</li> 
	{% highlight xml %}
	    <uses-permission android:name="android.permission.INTERNET" />
	{% endhighlight %}
	<li>Run app again and see that the Toast pops up</li>
	<li>Create the ResultActivity. ResultActivity will display a list containing the search results. Add entries to the Android Manifest</li>
    
    <li>Remove <code>Toast</code> and start the ResultActivity from the success callback using Intents. Explain that there are several ways to pass
    	objects between activities, for instance Parcelable. For simplicity, we pass the json as a <code>
    	stringExtra</code>. Parse the Result object using GSON and pass it.</li>

    <li>In the ResultActivity, parse the String as the Result domain object using GSON</li>
    <li> Explain that a <code>RecyclerView</code> can be used for displaying the results (<a href="list-recycler-view.html"> Lists and RecyclerView)</a> </li>
    <code>compile 'com.android.support:recyclerview-v7:+'</code> <code> compile 'com.android.support:cardview-v7:+'</code>
    <li> Set up a RecyclerView, and populate the RecyclerViewAdapter fields with properties from the Track domain objects</li>
    <li>Add a click handler for the list elements, where clicks will start Spotify and play song. Explain the use of implicit intents. An example
        can be opening Google Maps in Chrome, where the user is presented with options for which app to open maps in.</li>
</ol>


<h3> Retrofit SpotifySearchService</h3>
{% highlight java %}
public interface SpotifySearchService {
    @GET("/search/1/track.json")
    void searchForTracks(@Query("q") String searchString, Callback<Result> trackCallback);
}
{% endhighlight %}


{% highlight java %}
private static final String BASE_URL = "http://ws.spotify.com/";
   RestAdapter restAdapter = new RestAdapter.Builder()
                .setEndpoint(BASE_URL)
                .build();

   SpotifySearchService searchService = restAdapter.create(SpotifySearchService.class);
{% endhighlight %}

<h3> Result, Track and Artist classes</h3>

{% highlight java %}
public class Result {
    private List<Track> tracks;

    public List<Track> getTracks() {
        return tracks;
    }

    public void setTracks(List<Track> tracks) {
        this.tracks = tracks;
    }
}
	{% endhighlight %}

   {% highlight java %}

public class Track {
    private String name;
    private List<Artist> artists;
    private String href;

    public String getHref() {
        return href;
    }

    public void setHref(String href) {
        this.href = href;
    }

    public List<Artist> getArtists() {
        return artists;
    }

    public void setArtists(List<Artist> artists) {
        this.artists = artists;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
{% endhighlight %}

{% highlight java %}
public class Artist {
    private String name;

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
{% endhighlight %}


<h3>RecyclerViewAdapter</h3>
Adapter for displaying the search results in the RecyclerView
{% highlight java %}

public class SongResultAdapter extends RecyclerView.Adapter<SongResultAdapter.SongResultViewHolder> {
    private List<Track> tracks;

    public static class SongResultViewHolder extends RecyclerView.ViewHolder implements View.OnClickListener {
        TextView trackView;
        TextView artistView;
        ResultClickListener resultClickListener;

        public SongResultViewHolder(View itemView, ResultClickListener resultClickListener) {
            super(itemView);
            this.resultClickListener = resultClickListener;

            trackView = (TextView) itemView.findViewById(R.id.track_view);
            artistView = (TextView) itemView.findViewById(R.id.artist_view);
            itemView.setOnClickListener(this);
        }

        @Override
        public void onClick(View v) {
            resultClickListener.onClick(v, getPosition());
        }

        public interface ResultClickListener {
            public void onClick(View view, int position);
        }
    }

    public SongResultAdapter(List<Track> tracks){
        this.tracks = tracks;
    }

    @Override
    public SongResultViewHolder onCreateViewHolder(ViewGroup parent, int viewType) {
        View v = LayoutInflater.from(parent.getContext()).inflate(R.layout.search_result_card_row, parent, false);
        return new SongResultViewHolder(v, new SongResultViewHolder.ResultClickListener() {
            @Override
            public void onClick(View view, int position) {
                Track track = tracks.get(position);
                Intent appPlayBackIntent = new Intent(Intent.ACTION_VIEW, Uri.parse(track.getHref()));
                if (appPlayBackIntent.resolveActivity(view.getContext().getPackageManager()) != null) {
                    view.getContext().startActivity(appPlayBackIntent);
                }
            }
        });
    }

    @Override
    public void onBindViewHolder(SongResultViewHolder holder, int position) {
        holder.trackView.setText(tracks.get(position).getName());
        holder.artistView.setText(tracks.get(position).getArtists().get(0).getName());
    }

    @Override
    public int getItemCount() {
        return tracks.size();
    }
}

{% endhighlight %}
{% highlight xml %}
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_height="match_parent"
    android:layout_width="match_parent">
    <android.support.v7.widget.CardView
        xmlns:card_view="http://schemas.android.com/apk/res-auto"
        android:id="@+id/card_view"
        android:layout_gravity="center"
        android:layout_width="match_parent"
        android:layout_height="100dp"
        card_view:cardElevation="2sp"
        card_view:cardUseCompatPadding="true"
        card_view:cardCornerRadius="4dp">
        <LinearLayout
            android:orientation="vertical"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:layout_gravity="center_vertical">
            <TextView
                android:id="@+id/track_view"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/dummySong"
                android:textSize="30sp"
                android:layout_marginLeft="5dp" />
            <TextView
                android:id="@+id/artist_view"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="@string/dummyArtist"
                android:textSize="15sp"
                android:layout_marginLeft="10dp"
                android:layout_marginTop="10dp" />
            </LinearLayout>

    </android.support.v7.widget.CardView>
</LinearLayout>
{% endhighlight %}

<h3> ResultActivity</h3>
{% highlight java %}
public class ResultActivity extends ActionBarActivity {
    private RecyclerView searchResultView;
    private RecyclerView.Adapter searchResultAdapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_result);

        Bundle data = getIntent().getExtras();
        Gson gson = new Gson();
        Result result = gson.fromJson(data.getString("result"), Result.class);

        setupRecyclerView(result.getTracks());
    }

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        getMenuInflater().inflate(R.menu.menu_result, menu);
        return true;
    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        int id = item.getItemId();

        if (id == R.id.action_settings) {
            return true;
        }

        return super.onOptionsItemSelected(item);
    }

    private void setupRecyclerView(List<Track> tracks) {
        searchResultView = (RecyclerView) findViewById(R.id.song_result_view);
        searchResultAdapter = new SongResultAdapter(tracks);
        searchResultView.setAdapter(searchResultAdapter);
        searchResultView.setLayoutManager(new LinearLayoutManager(this));
    }
}
{% endhighlight %}
{% highlight java %}
<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent">
    <android.support.v7.widget.RecyclerView
        android:id="@+id/song_result_view"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:background="#ffffff">
    </android.support.v7.widget.RecyclerView>
</RelativeLayout>

{% endhighlight %}



{% highlight json %}
{
  "info": {
    "num_results": 1,
    "limit": 100,
    "offset": 0,
    "query": "\"godset fra drammen\"",
    "type": "track",
    "page": 1
  },
  "tracks": [
    {
      "album": {
        "released": "2008",
        "href": "spotify:album:7nrjbBpy8yrueDbKCBY6Ef",
        "name": "2 x femogf√∏rr",
        "availability": {
          "territories": "AD AR AT AU BE BG BO BR CA CH CL CO CR CY CZ DE DK DO EC EE ES FI FR GB GR GT HK HN HR HU IE IS IT LI LT LU LV MC MT MX MY NI NL NO NZ PA PE PH PL PT PY RO SE SG SI SK SV TR TW US UY"
        }
      },
      "name": "Godset fra Drammen",
      "popularity": "0.36",
      "external-ids": [
        {
          "type": "isrc",
          "id": "NOFFM0897080"
        }
      ],
      "length": 258.786,
      "href": "spotify:track:67jdp9WXPR3ihTic9WXwmG",
      "artists": [
        {
          "href": "spotify:artist:4AiqdizfguNQoWQ5N6Aaza",
          "name": "C-laget"
        }
      ],
      "track-number": "8"
    }
  ]
}

{% endhighlight %}

